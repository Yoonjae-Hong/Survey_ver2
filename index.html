<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Floorplan Design Tool</title>

  <style>
    * { box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; }
    body { margin: 0; padding: 0; background:#f5f5f7; color:#222; }

    .app-container { display:flex; flex-direction:column; height:100vh; }

    .header { padding:12px 20px; background:#fff; border-bottom:1px solid #ddd; }
    .header-title { font-size:18px; font-weight:600; }

    .main { flex:1; display:grid; grid-template-columns:260px 1fr; gap:12px; padding:12px; }
    .panel { background:#fff; border-radius:14px; padding:12px; box-shadow:0 2px 6px rgba(0,0,0,0.04); display:flex; flex-direction:column; }

    .instruction-bar {
      font-size:12px; color:#555;
      background:#f0f0f0;
      padding:6px 10px;
      border-radius:8px;
      border:1px solid #ddd;
      margin-bottom:8px;
      line-height:1.4;
    }

    .canvas-wrapper { display:flex; flex-direction:column; gap:8px; }

    .canvas {
      position:relative;
      flex:1;
      min-height:360px;
      border:1px solid #ccc;
      background:
        linear-gradient(#e0e0e0 1px, transparent 1px),
        linear-gradient(90deg, #e0e0e0 1px, transparent 1px);
      background-size: 10px 10px;  /* 정사각형 그리드, JS에서도 다시 세팅 */
      overflow:hidden;
    }

    .compass {
      position:absolute;
      top:10px; right:10px;
      width:70px; height:70px;
      border-radius:50%;
      background:rgba(255,255,255,0.9);
      border:2px solid #555;
      box-shadow:0 2px 4px rgba(0,0,0,0.15);
      z-index:20;
    }
    .compass div { position:absolute; font-weight:700; font-size:13px; color:#333; }
    .north { top:4px; left:50%; transform:translateX(-50%); }
    .east  { right:4px; top:50%; transform:translateY(-50%); }
    .south { bottom:4px; left:50%; transform:translateX(-50%); }
    .west  { left:4px; top:50%; transform:translateY(-50%); }

    .person-icon {
      position:absolute;
      width:40px;
      height:60px;
      pointer-events:none; /* 고정, 드래그/클릭 불가 */
      z-index:18;
    }

    .canvas-shape {
      position:absolute;
      border:1px solid rgba(0,0,0,0.3);
      display:flex;
      justify-content:center;
      align-items:center;
      font-size:11px;
      cursor:move;
      user-select:none;
      padding:3px;
      text-align:center;
      background:rgba(59,130,246,0.25);
    }

    .canvas-shape.selected { box-shadow:0 0 0 2px #1d4ed8; }

    .btn { padding:6px 10px; border-radius:6px; font-size:12px; cursor:pointer; border:1px solid #ccc; background:#fff; }
    .btn-primary { background:#2563eb; color:white; border-color:#2563eb; }

    textarea { width:100%; height:100px; padding:6px; font-size:11px; background:#fafafa; border-radius:8px; border:1px solid #ddd; }
  </style>
</head>

<body>
<div class="app-container">

  <header class="header">
    <div class="header-title">Floorplan Design Tool</div>
  </header>

  <main class="main">

    <!-- LEFT PANEL -->
    <section class="panel">
      <h3 style="margin:4px 0 10px 0;">Create a Custom Room</h3>

      <label>Room Type</label>
      <select id="customRoomType" style="padding:4px; margin-bottom:8px;">
        <option>Living Room</option>
        <option>Kitchen</option>
        <option>Dining Room</option>
        <option>Master Bedroom</option>
        <option>Guest Bedroom</option>
        <option>Bathroom</option>
        <option value="Others">Others</option>
      </select>

      <div id="labelContainer" style="display:none; margin-bottom:8px;">
        <label>Custom Label</label>
        <input id="customLabelInput" type="text" placeholder="Enter custom name"
               style="padding:4px; margin-top:4px; width:100%;">
      </div>

      <label>Width (1 grid unit = 60cm)</label>
      <input id="customWidth" type="number" min="1" value="5" style="padding:4px; margin-bottom:8px;">

      <label>Length (1 grid unit = 60cm)</label>
      <input id="customHeight" type="number" min="1" value="3" style="padding:4px; margin-bottom:12px;">

      <button id="addCustomRoomBtn" class="btn btn-primary">Add Room</button>

      <hr style="margin:16px 0;">

      <button id="clearCanvasBtn" class="btn">Clear Canvas</button>
      <button id="exportJsonBtn" class="btn btn-primary" style="margin-top:8px;">Save JSON + PNG</button>
    </section>


    <!-- RIGHT PANEL -->
    <section class="panel canvas-wrapper">

      <div class="instruction-bar">
        Instruction: Select a room type and enter its size. Drag rooms on the canvas to design your floor plan.
        Use Delete to remove a room. Save JSON + PNG to download the files.
      </div>

      <div class="canvas" id="canvas">

        <!-- Compass -->
        <div class="compass" id="compass">
          <div class="north">N</div>
          <div class="east">E</div>
          <div class="south">S</div>
          <div class="west">W</div>
        </div>

        <!-- Person Icon (fixed under compass center) -->
        <img id="personIcon"
             class="person-icon"
             src="https://raw.githubusercontent.com/Yoonjae-Hong/Survey_ver2/76437d43f2a49ee041422c151b7c6ec6c5576320/Assets/person.png">
      </div>

      <textarea id="layoutOutput" readonly placeholder="Layout JSON will appear here"></textarea>

    </section>
  </main>
</div>


<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<script>
/* ====== GRID & UNIT SETTINGS ====== */
const GRID_SIZE = 15;      // 정사각형 그리드 px 크기 (전에 20 → 10으로 더 촘촘)
const CM_PER_UNIT = 60;    // 1 grid = 60cm

const canvas = document.getElementById("canvas");
const compass = document.getElementById("compass");
const personIcon = document.getElementById("personIcon");

const addBtn = document.getElementById("addCustomRoomBtn");
const clearBtn = document.getElementById("clearCanvasBtn");
const saveBtn = document.getElementById("exportJsonBtn");
const typeSelect = document.getElementById("customRoomType");
const labelContainer = document.getElementById("labelContainer");
const output = document.getElementById("layoutOutput");

let shapes = [];
let selectedId = null;
let shapeIdCounter = 1;

/* 초기 GRID 백그라운드 설정 + 사람 위치 */
window.onload = () => {
  canvas.style.backgroundSize = GRID_SIZE + "px " + GRID_SIZE + "px";
  positionPersonIcon();
};

/* compass 중앙 아래에 사람 고정 */
function positionPersonIcon() {
  const compassRect = compass.getBoundingClientRect();
  const canvasRect = canvas.getBoundingClientRect();

  const personWidth = 40;
  const personHeight = 60;

  const left =
    (compassRect.left - canvasRect.left) + (compassRect.width / 2) - (personWidth / 2);

  const top = (compassRect.bottom - canvasRect.top) + 5; // 컴퍼스 아래 + 5px

  personIcon.style.left = left + "px";
  personIcon.style.top = top + "px";
}

/* Others 선택 시 label 입력칸 보이기 */
typeSelect.addEventListener("change", () => {
  labelContainer.style.display = (typeSelect.value === "Others") ? "block" : "none";
});

/* ====== 방 생성 ====== */
addBtn.addEventListener("click", () => {
  const type = typeSelect.value;
  const wUnits = +document.getElementById("customWidth").value;
  const hUnits = +document.getElementById("customHeight").value;

  if (wUnits <= 0 || hUnits <= 0) {
    alert("Size must be positive.");
    return;
  }

  const w = wUnits * GRID_SIZE;
  const h = hUnits * GRID_SIZE;

  let label = type;
  if (type === "Others") {
    const customLabel = document.getElementById("customLabelInput").value.trim();
    if (!customLabel) {
      alert("Enter custom label.");
      return;
    }
    label = customLabel;
  }

  const rect = canvas.getBoundingClientRect();
  const x = Math.round((rect.width / 2 - w / 2) / GRID_SIZE) * GRID_SIZE;
  const y = Math.round((rect.height / 2 - h / 2) / GRID_SIZE) * GRID_SIZE;

  addShape({
    roomType: type,
    label: `${label} (${wUnits}×${hUnits})`,
    x,
    y,
    width: w,
    height: h
  });
});

/* DOM에 사각형 추가 */
function addShape({ roomType, label, x, y, width, height }) {
  const id = "shape_" + shapeIdCounter++;

  const div = document.createElement("div");
  div.className = "canvas-shape";
  div.dataset.id = id;
  div.style.left = x + "px";
  div.style.top = y + "px";
  div.style.width = width + "px";
  div.style.height = height + "px";
  div.textContent = label;

  canvas.appendChild(div);

  shapes.push({ id, roomType, label, x, y, width, height });

  attachMove(div);
  updateJSON();
}

/* ====== 드래그 이동 ====== */
function attachMove(el) {
  el.addEventListener("mousedown", (e) => {
    selectedId = el.dataset.id;

    const startX = e.clientX;
    const startY = e.clientY;
    const initialLeft = parseFloat(el.style.left);
    const initialTop = parseFloat(el.style.top);

    function move(ev) {
      let nx = initialLeft + (ev.clientX - startX);
      let ny = initialTop + (ev.clientY - startY);

      nx = Math.round(nx / GRID_SIZE) * GRID_SIZE;
      ny = Math.round(ny / GRID_SIZE) * GRID_SIZE;

      el.style.left = nx + "px";
      el.style.top = ny + "px";

      const s = shapes.find(o => o.id === selectedId);
      if (s) {
        s.x = nx;
        s.y = ny;
      }

      updateJSON();
    }

    function stop() {
      document.removeEventListener("mousemove", move);
      document.removeEventListener("mouseup", stop);
    }

    document.addEventListener("mousemove", move);
    document.addEventListener("mouseup", stop);
  });
}

/* ====== Delete 키로 방 삭제 (person은 아예 shapes에 없음) ====== */
document.addEventListener("keydown", (e) => {
  if ((e.key === "Delete" || e.key === "Backspace") && selectedId) {
    const el = canvas.querySelector(`[data-id="${selectedId}"]`);
    if (!el) return;

    el.remove();
    shapes = shapes.filter(s => s.id !== selectedId);
    selectedId = null;
    updateJSON();
  }
});

/* ====== JSON Export (1 grid = 60cm) ====== */
function updateJSON() {
  const result = shapes.map(s => {
    const xUnits = s.x / GRID_SIZE;
    const yUnits = s.y / GRID_SIZE;
    const wUnits = s.width / GRID_SIZE;
    const hUnits = s.height / GRID_SIZE;

    return {
      id: s.id,
      roomType: s.roomType,
      label: s.label,
      x: xUnits * CM_PER_UNIT,
      y: yUnits * CM_PER_UNIT,
      width: wUnits * CM_PER_UNIT,
      height: hUnits * CM_PER_UNIT
    };
  });

  output.value = JSON.stringify(result, null, 2);
}

/* ====== Clear Canvas (사람/컴퍼스는 그대로) ====== */
clearBtn.addEventListener("click", () => {
  if (!confirm("Clear all rooms?")) return;

  shapes = [];
  [...canvas.querySelectorAll(".canvas-shape")].forEach(el => el.remove());
  updateJSON();
});

/* ====== Save JSON + PNG ====== */
saveBtn.addEventListener("click", async () => {
  const blob = new Blob([output.value], { type:"application/json" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "layout.json";
  a.click();
  URL.revokeObjectURL(url);

  const screenshot = await html2canvas(canvas, { backgroundColor:null, scale:2 });
  screenshot.toBlob((imgBlob) => {
    const pngUrl = URL.createObjectURL(imgBlob);
    const a2 = document.createElement("a");
    a2.href = pngUrl;
    a2.download = "layout.png";
    a2.click();
    URL.revokeObjectURL(pngUrl);
  });

  alert("Saved JSON + PNG");
});
</script>

</body>
</html>

